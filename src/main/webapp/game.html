<html>
<head>
    <meta charset="UTF-8">
    <title>五子棋</title>
    <style>
        table {
            border-collapse: collapse;
        }
        td {
            width: 30px;
            height: 30px;
            text-align: center;
            vertical-align: middle;
        }
    </style>
    <script>
        // 初始化一个 15x15 的二维字符数组
      let board = Array.from({ length: 15 }, () => Array(15).fill('\0'));

      //   // 输出初始化后的二维数组
      // console.log(board);
      let playerName = '';
      let socket;

      let lastCol = 0;
      let lastRow = 0;

      function renderBoard() {
        const table = document.getElementById('board');
        table.innerHTML = '';

        for (let i = 0; i < board.length; i++) {
          const row = document.createElement('tr');
          for (let j = 0; j < board[i].length; j++) {
            const cell = document.createElement('td');
            cell.dataset.row = i;
            cell.dataset.col = j;
            if (board[i][j] === '\0') {
              cell.innerHTML = `<img src="/gomoku/images/empty.gif" style="width:30px;height:30px;" onclick="forwardMove(${i}, ${j})">`;
            } else if (board[i][j] === 'X') {
              cell.innerHTML = `<img src="/gomoku/images/x.gif" style="width:30px;height:30px;">`;
            } else if (board[i][j] === 'O') {
              cell.innerHTML = `<img src="/gomoku/images/o.gif" style="width:30px;height:30px;">`;
            }
            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }

      function forwardMove(row, col) {
        if (board[row][col] === '\0') {  // Only allow move if the cell is empty
            socket.send(JSON.stringify({msgKind:'move',moveKind:'forward',place:{row: row, col: col}}));
        }
      }

      function judgeGame(row, col, color, playerName) {
        var offset = 1;     //前进或回退步数
        var count = 1;      //统计连线棋子的个数
        var type = 1;       //查询棋子连线的四个方向
        var big = 0;
        while(type < 5){
          switch(type){
              case 1:             //水平方向
                  while(col - offset >= 0 && board[row][col - offset] == color){
                    count = count + 1;
                    offset++;
                  }
                  offset = 1;
                  while(col + offset <= board.length && board[row][col + offset] == color){
                    count++;
                    offset++;
                  }
                  break;

              case 2:           //垂直方向
                  while(row - offset >= 0 && board[row - offset][col] == color){
                    count = count + 1;
                    offset++;
                  }
                  offset = 1;
                  while(row + offset <= board.length && board[row + offset][col] == color){
                    count++;
                    offset++;
                  }
                  break;

              case 3:           //左斜上方向
                  while(col - offset >= 0 && row - offset >= 0 && board[row - offset][col - offset] == color){
                    count++;
                    offset++;
                  }
                  offset = 1;
                  while(col + offset <= board.length && row + offset <= board.length && board[row + offset][col + offset] == color){
                    count++;
                    offset++;
                  }
                  break;

              case 4:           //右斜上方向
                  while(col - offset >= 0 && row + offset >= 0 && board[row + offset][col - offset] == color){
                    count++;
                    offset++;
                  }
                  offset = 1;
                  while(col + offset <= board.length && row - offset <= board.length && board[row - offset][col + offset] == color){
                    count++;
                    offset++;
                  }
                  break;

          }
          if(count >= big){
            big = count;
          }
          if(count == 5)
          {
            socket.send(JSON.stringify({msgKind: 'win', name : playerName}));
            break;
          }
          count = 1;
          offset = 1;
          type = type + 1;
        }
      }

      function startGame() {
          const input = document.getElementById('playerName');
          playerName = input.value;
          document.getElementById('welcome').innerText = `欢迎, ${playerName}！`;
          document.getElementById('status').innerText = `等待对手连接...`;
          document.getElementById('startButton').style.display = 'none';

          // Initialize WebSocket connection
          socket = new WebSocket('ws://' + window.location.host + '/gomoku/game');
          socket.onopen = function() {
            socket.send(JSON.stringify({msgKind: 'start', name : playerName}));
          }
          socket.onmessage = function(event) {
          const data = JSON.parse(event.data);
          if (data.msgKind == 'move') {
            const place = data.place;
            if(data.color == '\0'){
              board[lastRow][lastCol] = data.color;
              renderBoard();
            }
            else
            {             
              board[place.row][place.col] = data.color;
              renderBoard();
              lastCol = place.col;
              lastRow = place.row;
             //判断胜利条件
              if(data.right == 1)
              {judgeGame(place.row,place.col,data.color,data.playerName);}//这里的playername不确定是不是data的，想表达当前这一步的玩家名
            }
            /*board[place.row][place.col] = data.color;
            if(data.color == '\0')
              alert("regret");
            renderBoard();
             //判断胜利条件
            if(data.right == 1)
            {judgeGame(place.row,place.col,data.color,data.playerName);}//这里的playername不确定是不是data的，想表达当前这一步的玩家名
            alert(place.row + "  " + place.col);
            */
          }
          if (data.msgKind == 'start') {
            const player1Name = data.name;
            const player2Name = data.opName;
            document.getElementById('status').innerText = `对战开始`;
            document.getElementById('game').innerText = `${player1Name} vs ${player2Name}`;
            renderBoard();
          }
          if (data.msgKind == 'wait') {
            alert("请等待您的对手先下...");
          }
          if (data.msgKind == 'win') {
            alert("恭喜您成功获得胜利");
          }
          if (data.msgKind == 'lose') {
            alert("很遗憾,您输了这场对局");//不知道在哪里转变msgKind
          }
          if (data.msgKind == 'regret') {
            alert("确认悔棋。");
            const place = data.place;
            board[place.row][place.col] = data.color;
            renderBoard();
          }
        };
      }

      window.onload = function() {
          document.getElementById('startButton').onclick = startGame;
      };
    </script>
</head>
      <script>
        
      function someoneRegret(a) {
            socket.send(JSON.stringify({msgKind:'move',moveKind:'backward'}));
      }
      </script>
<body>
    <h1>五子棋</h1>
    <div>
        <label for="playerName">请输入您的姓名：</label>
        <input type="text" id="playerName" name="playerName">
        <button id="startButton">开始游戏</button>
    </div>
    <h2 id="welcome"></h2>
    <h2 id="status"></h2>
    <h2 id="game"></h2>
    <table id="board" border="1"></table>    
    <button id="regretlastmove" type = "button" onclick="someoneRegret(1)">悔棋</button>
</body>
</html>
